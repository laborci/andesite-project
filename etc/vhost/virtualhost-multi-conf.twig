{% set attachments = module.configs["attachment-repository"] %}

{% for subdomain in sys.vhost.subdomains %}
{% set domain = subdomain ~ sys.domain %}

	{% if sys.vhost.ssl %}

		<VirtualHost *:80>
			ServerName "{{ domain }}"

			Alias /.well-known/acme-challenge {{ sys.vhost.ssl.challange }}

			<Directory {{ sys.vhost.ssl.challange }}>
				Options None
				AllowOverride None

				# Apache 2.x
				<IfModule !mod_authz_core.c>
					Order allow,deny
					Allow from all
				</IfModule>

				# Apache 2.4
				<IfModule mod_authz_core.c>
					Require all granted
				</IfModule>
			</Directory>

			RewriteEngine On
			RewriteCond %{HTTPS} off
			RewriteCond %{REQUEST_URI} !^\/\.well-known\/.*$
			RewriteRule (.*) https://{{ domain }}/$1 [R,L]

		</VirtualHost>

	{% endif %}

	<VirtualHost *:{{ sys.vhost.ssl ? 443 : 80 }}>
		ServerName "{{ domain }}"

		DirectoryIndex "index.php"
		DocumentRoot "{{ path.public }}"
		ErrorLog "{{ root }}var/error.log"

		{% for name, attachment in attachments %}

			Alias "{{ attachment.thumbnail.url }}" "{{ attachment.thumbnail.path }}"
			<Directory "{{ attachment.thumbnail.path }}" >
				Require all granted
				AllowOverride all
				RewriteEngine On
				RewriteCond %{REQUEST_FILENAME} !-f
				RewriteRule . /index.php [L]
			</Directory>

			Alias "{{ attachment.url }}" "{{ attachment.path }}"
			<Directory "{{ attachment.path }}" >
				Require all granted
				AllowOverride all
			</Directory>

		{% endfor %}

		<Directory "{{ path.public }}">
			Require all granted
			AllowOverride all
			Options -Indexes
			Options +FollowSymlinks

			{% if not sys.vhost.fpm %}

				{% for config in sys.vhost.php %}
					php_{{ config.type }} {{ config.key }} {{ config.value }}
				{% endfor %}

			{% endif %}

			RewriteEngine On

			RewriteCond %{REQUEST_FILENAME} !-d
			RewriteRule ^(.*)/$ /$1 [L,R]

			RewriteCond %{REQUEST_URI} !(^/~.+)
			RewriteCond %{REQUEST_FILENAME} !-f
			RewriteRule . /index.php [L]
		</Directory>

		{% if sys.vhost.fpm %}

			<FilesMatch \.php$>
				SetHandler "{{ sys.vhost.fpm.handler }}"
			</FilesMatch>

		{% endif %}

		{% if sys.vhost.ssl %}

			SSLEngine On
			SSLHonorCipherOrder On
			SSLProtocol all -SSLv2 -SSLv3
			SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
			SSLCertificateKeyFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ domain }}/privkey.pem
			SSLCertificateFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ domain }}/cert.pem
			SSLCACertificateFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ domain }}/chain.pem

		{% endif %}

	</VirtualHost>

{% endfor %}
