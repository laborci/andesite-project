{% set attachments = module.configs["attachment-repository"] %}
<VirtualHost *:{{ sys.vhost.ssl ? 443 : 80 }}>

	ServerName "{{ sys.domain }}"
	ServerAlias "*.{{ sys.domain }}

	DirectoryIndex "index.php"
	DocumentRoot "{{ path.public }}"
	ErrorLog "{{ root }}var/error.log"

	{% for name, attachment in attachments %}

		Alias "{{ attachment.thumbnail.url }}" "{{ attachment.thumbnail.path }}"
		<Directory "{{ attachment.thumbnail.path }}" >
		Require all granted
		AllowOverride all
		RewriteEngine On
		RewriteCond %{REQUEST_FILENAME} !-f
		RewriteRule . /index.php [L]
		</Directory>

		Alias "{{ attachment.url }}" "{{ attachment.path }}"
		<Directory "{{ attachment.path }}" >
		Require all granted
		AllowOverride all
		</Directory>

	{% endfor %}

	<Directory "{{ path.public }}">
	Require all granted
	AllowOverride all
	Options -Indexes
	Options +FollowSymlinks

	{% if not sys.vhost.fpm %}{% for config in sys.vhost.php %}

		php_{{ config.type }} {{ config.key }} {{ config.value }}
	{% endfor %}{% endif %}

	RewriteEngine On

	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteRule ^(.*)/$ /$1 [L,R]

	RewriteCond %{REQUEST_URI} !(^/~.+)
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteRule . /index.php [L]
	</Directory>

	{% if sys.vhost.fpm %}

		<FilesMatch \.php$>
			SetHandler "{{ sys.vhost.fpm.handler }}"
		</FilesMatch>

	{% endif %}

	{% if sys.vhost.ssl %}

		SSLEngine On
		SSLHonorCipherOrder On
		SSLProtocol all -SSLv2 -SSLv3
		SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
		SSLCertificateKeyFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ sys.domain }}/privkey.pem
		SSLCertificateFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ sys.domain }}/cert.pem
		SSLCACertificateFile {{ sys.vhost.ssl["dehydrated-path"] }}{{ sys.domain }}/chain.pem

	{% endif %}

</VirtualHost>

